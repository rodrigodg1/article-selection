{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-baseline">
  <h3>Label articles</h3>
  <div>
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('upload') }}">Upload new</a>
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('review', dataset_id=dataset_id) }}">Review</a>
    <a class="btn btn-outline-success btn-sm" href="{{ url_for('export', dataset_id=dataset_id) }}">Export CSV</a>
  </div>
</div>

<div class="mb-2 muted">
  Dataset {{ dataset_id }} &middot;
  Yes: <b>{{ yes }}</b> &nbsp;
  No: <b>{{ no }}</b> &nbsp;
  Unlabeled: <b>{{ unlabeled }}</b> &nbsp;
  Total: <b>{{ total }}</b>
</div>

{# Progress bar #}
{% if total and total > 0 %}
<div class="mb-3">
  <div class="d-flex justify-content-between small mb-1">
    <div><strong>Progress:</strong> {{ pct_done }}%</div>
    <div><span class="muted">Remaining: {{ unlabeled }}</span></div>
  </div>
  <div class="progress" role="progressbar" aria-valuenow="{{ pct_done }}" aria-valuemin="0" aria-valuemax="100">
    <div
      class="progress-bar {% if pct_done >= 100 %}bg-success{% elif pct_done >= 60 %}bg-info{% elif pct_done >= 30 %}bg-warning{% else %}bg-secondary{% endif %}"
      style="width: '{{ pct_done|default(0, true) }}%';">
      {{ pct_done }}%
    </div>
  </div>
</div>
{% endif %}

{% if article %}
<div class="card mb-3">
  <div class="card-body">
    <h5 class="card-title">{{ article.title or '[No title]' }}</h5>
    <h6 class="card-subtitle mb-1 text-muted">{{ article.year or '' }}</h6>

    {% if doi %}
    <div class="mb-1"><strong>DOI:</strong>
      <a href="https://doi.org/{{ doi }}" target="_blank" rel="noopener">{{ doi }}</a>
    </div>
    {% endif %}

    {% if source_title %}
    <div class="mb-1"><strong>Source title:</strong> {{ source_title }}</div>
    {% endif %}

    {% if cited_by is not none %}
    <div class="mb-2"><strong>Cited by:</strong> {{ cited_by }}</div>
    {% endif %}

    {# ---------- PMR BLOCK (Ollama output shown here) ---------- #}
    {% if pmr and (pmr.problem or pmr.method or pmr.results) %}
    <div class="d-flex align-items-center gap-2 mb-2">
      <span class="badge text-bg-light border">
        PMR source: {{ pmr_source }}
      </span>
    </div>
    <div class="pmr-grid">
      <div class="pmr-card">
        <h6>Problem</h6>
        <p class="pmr-text">{{ pmr.problem or '—' }}</p>
      </div>
      <div class="pmr-card">
        <h6>Method</h6>
        <p class="pmr-text">{{ pmr.method or '—' }}</p>
      </div>
      <div class="pmr-card">
        <h6>Results</h6>
        <p class="pmr-text">{{ pmr.results or '—' }}</p>
      </div>
    </div>
    {% endif %}
    {# ---------------------------------------------------------- #}

    <div class="abstract-box">
      <pre>{{ (article.abstract or '[No abstract]') |  hilite(highlight_terms, highlight_is_regex) | safe }}</pre>
    </div>



    {% if article.extra_json %}
    <details class="mt-2">
      <summary>Other columns</summary>
      <table class="table table-sm mt-2">
        {% for k,v in article.extra_json.items() %}
        {% if k != 'pmr' %} {# hide the cached pmr dict from this table #}
        <tr>
          <th style="width: 200px;">{{ k }}</th>
          <td>{{ v }}</td>
        </tr>
        {% endif %}
        {% endfor %}
      </table>
    </details>
    {% endif %}
  </div>

  <div class="sticky-footer d-flex gap-2">
    <form method="post" action="{{ url_for('label_submit', article_id=article.id) }}" class="d-flex w-100 gap-2">
      <input class="form-control" name="notes" placeholder="Notes (optional)">
      <button name="decision" value="no" class="btn btn-outline-danger">Not related</button>
      <button name="decision" value="skip" class="btn btn-outline-secondary">Skip</button>
      <button name="decision" value="yes" class="btn btn-success">Related</button>
    </form>
  </div>
</div>
{% else %}
<div class="alert alert-success">
  All items in this dataset are labeled. Use <b>Review</b> to inspect or relabel, or <b>Upload</b> to start a new set.
</div>
{% endif %}
{% endblock %}