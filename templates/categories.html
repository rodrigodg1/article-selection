{% extends "base.html" %}
{% block content %}
<style>
    .cat-sidebar {
        position: sticky;
        top: 5rem;
        align-self: start;
        max-height: calc(100vh - 6rem);
        overflow: auto;
    }

    .cat-list .form-check {
        margin-bottom: .25rem;
    }

    .abstract-snippet {
        max-height: 8rem;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }

    .abstract-expanded {
        max-height: none !important;
    }


    .cat-actions {
        gap: .5rem;
    }

    .abstract-snippet {
        max-height: 8rem;
        overflow: hidden;
    }
</style>

<div class="d-flex justify-content-between align-items-baseline">
    <h3>Categories</h3>
    <div>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('label_next', dataset_id=dataset_id) }}">Back to
            labeling</a>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('review', dataset_id=dataset_id) }}">Review</a>
    </div>
</div>

<div class="mb-2 muted">
    Dataset {{ dataset_id }} &middot;
    Yes: <b>{{ yes }}</b> &nbsp;
    No: <b>{{ no }}</b> &nbsp;
    Unlabeled: <b>{{ unlabeled }}</b> &nbsp;
    Total: <b>{{ total }}</b>
</div>

<div class="row g-3">
    <div class="col-12 col-lg-3">
        <div class="card cat-sidebar">
            <div class="card-body">
                <h6 class="card-title mb-2">Filter by categories</h6>

                <form method="get" class="cat-list">
                    {% for c in categories %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="{{ c.id }}" id="cat{{ c.id }}" name="cat"
                            {% if c.id in selected %}checked{% endif %}>
                        <label class="form-check-label" for="cat{{ c.id }}">
                            {{ c.name }}
                            <small class="text-muted">({{ counts_map.get(c.id, 0) }})</small>
                        </label>
                    </div>
                    {% endfor %}

                    <div class="d-flex cat-actions mt-3">
                        <button type="submit" class="btn btn-primary btn-sm">Apply</button>
                        <a class="btn btn-outline-secondary btn-sm"
                            href="{{ url_for('categories', dataset_id=dataset_id) }}">Clear</a>
                    </div>
                </form>

                {% if selected %}
                <div class="small text-muted mt-2">
                    Selected: {{ selected|length }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-9">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title mb-2">Articles{% if selected %} (filtered){% endif %}</h6>

                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th style="width:72px;">ID</th>
                                <th>Title</th>
                                <th style="width:220px;">Year / DOI</th>
                                <th>Abstract</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for a in rows %}
                            <tr>
                                <td class="mono">{{ a.id }}</td>
                                <td>
                                    <div class="fw-semibold">{{ a.title or '' }}</div>
                                    {% if a.categories %}
                                    <div class="small">
                                        {% for c in a.categories %}
                                        <span class="chip">{{ c.name }}</span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <div>{{ a.year or '' }}</div>
                                    {% set doi_val = None %}
                                    {% if a.extra_json %}
                                    {% for key, value in a.extra_json.items() %}
                                    {% if doi_val is none and 'doi' in key|lower %}
                                    {% set raw = (value|string).strip() %}
                                    {% set doi_val = raw
                                    | replace('https://doi.org/','')
                                    | replace('http://doi.org/','')
                                    | replace('DOI:','')
                                    | replace('doi:','')
                                    | trim %}
                                    {% endif %}
                                    {% endfor %}
                                    {% endif %}
                                    {% if doi_val %}
                                    <div class="small">
                                        <a href="https://doi.org/{{ doi_val }}" target="_blank" rel="noopener">DOI: {{
                                            doi_val }}</a>
                                    </div>
                                    {% endif %}
                                </td>

                                <td>
                                    <div class="abstract-box abstract-snippet" id="abs-{{ a.id }}">
                                        <pre
                                            class="mb-0">{{ (a.abstract or '[No abstract]') | hilite(highlight_terms, highlight_is_regex) | safe }}</pre>
                                    </div>
                                    {% if a.abstract and a.abstract|length > 400 %}
                                    <button class="btn btn-link btn-sm p-0 mt-1 toggle-abs"
                                        data-target="abs-{{ a.id }}">Show more</button>
                                    {% endif %}
                                </td>




                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="muted">No articles for this filter.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
</div>






<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".toggle-abs").forEach(btn => {
            btn.addEventListener("click", function () {
                const targetId = btn.getAttribute("data-target");
                const box = document.getElementById(targetId);
                if (box.classList.contains("abstract-expanded")) {
                    box.classList.remove("abstract-expanded");
                    btn.textContent = "Show more";
                } else {
                    box.classList.add("abstract-expanded");
                    btn.textContent = "Show less";
                }
            });
        });
    });
</script>











{% endblock %}